<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>BRICS Unit Basket v1</title>

<script src="https://unpkg.com/lightweight-charts@5/dist/lightweight-charts.standalone.production.js"></script>

<style>
  body {
    background:#0b0f14;
    color:#eaeaea;
    font-family:Arial, sans-serif;
    padding:20px;
  }
  .container {
    max-width:1100px;
    margin:auto;
  }
  h1 {
    text-align:center;
    color:#ffd700;
    margin-bottom:12px;
  }
  #chart {
    height:450px;
    background:#0b0f14;
    border-radius:8px;
  }
  .price-box {
    background:#151a21;
    padding:15px;
    border-radius:8px;
    margin-bottom:15px;
  }
  .row {
    margin:4px 0;
  }
  .legend {
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    margin-top:12px;
    font-size:0.9em;
  }
  .legend label {
    cursor:pointer;
    user-select:none;
  }
</style>
</head>

<body>
<div class="container">

<h1>BRICS Unit Basket v1</h1>

<div class="price-box">
  <div class="row">Unit (USD): <b><span id="unitUsd">â€¦</span></b></div>
  <div class="row">100 Units (USD): <span id="hundredUsd">â€¦</span></div>
  <div class="row">Gold TWAP (USD/oz): <span id="goldPrice">â€¦</span></div>
  <div class="row">Gold grams per unit: <span>0.9823</span></div>
  <div class="row">Last update: <span id="timestamp">â€¦</span></div>
</div>

<div id="chart"></div>
<div class="legend" id="legend"></div>

</div>

<script>
/* ================= CONFIG ================= */

// ðŸ”´ CHANGE NOTHING EXCEPT THIS IF SERVER MOVES
const FEED_URL = "https://b-twap.onrender.com/latest.json";

/* ================= CHART ================= */

const chart = LightweightCharts.createChart(
  document.getElementById("chart"),
  {
    layout: { background: { color:"#0b0f14" }, textColor:"#eaeaea" },
    grid: {
      vertLines:{ color:"#333" },
      horzLines:{ color:"#333" }
    },
    timeScale: {
      timeVisible:true,
      secondsVisible:true
    }
  }
);

/* ================= SERIES ================= */

// Gold (USD/oz) candlesticks
const goldSeries = chart.addCandlestickSeries({
  upColor:"#ffd700",
  downColor:"#ff4b4b",
  wickUpColor:"#ffd700",
  wickDownColor:"#ff4b4b",
  borderVisible:false
});

// FX USD contribution lines
const fxColors = {
  BRL: "#009c3b",
  RUB: "#0039a6",
  INR: "#ff9933",
  CNY: "#de2910",
  ZAR: "#007749"
};

const fxSeries = {};
Object.keys(fxColors).forEach(ccy => {
  fxSeries[ccy] = chart.addLineSeries({
    color: fxColors[ccy],
    lineWidth: 2,
    priceLineVisible: false
  });
});

// Total unit overlay
const unitSeries = chart.addLineSeries({
  color:"#cd7f32",
  lineWidth:3,
  priceLineVisible:true
});

/* ================= LEGEND ================= */

const legend = document.getElementById("legend");

function addToggle(label, series, checked=true) {
  const id = "toggle_" + label;
  const el = document.createElement("label");
  el.innerHTML =
    `<input type="checkbox" id="${id}" ${checked?"checked":""}> ${label}`;
  legend.appendChild(el);
  document.getElementById(id).onchange =
    e => series.applyOptions({ visible:e.target.checked });
}

addToggle("Gold (USD/oz)", goldSeries);
Object.keys(fxSeries).forEach(ccy => addToggle(ccy, fxSeries[ccy]));
addToggle("Total Unit", unitSeries);

/* ================= DATA LOOP ================= */

let goldCandle = null;
let goldHistory = [];

async function tick() {
  try {
    const res = await fetch(FEED_URL);
    const d = await res.json();
    const t = Math.floor(Date.now() / 1000);

    // Header
    document.getElementById("unitUsd").textContent =
      d.unit_usd.toFixed(2);
    document.getElementById("hundredUsd").textContent =
      d.hundred_units_usd.toFixed(2);
    document.getElementById("goldPrice").textContent =
      d.gold.usd_per_oz_twap.toFixed(2);
    document.getElementById("timestamp").textContent =
      d.timestamp_utc.replace("T"," ").replace("Z"," UTC");

    // Gold candles (USD/oz)
    const g = d.gold.usd_per_oz_twap;
    if (!goldCandle || goldCandle.time !== t) {
      if (goldCandle) goldHistory.push(goldCandle);
      goldCandle = { time:t, open:g, high:g, low:g, close:g };
      goldSeries.setData(goldHistory.concat([goldCandle]));
    } else {
      goldCandle.high = Math.max(goldCandle.high, g);
      goldCandle.low = Math.min(goldCandle.low, g);
      goldCandle.close = g;
      goldSeries.update(goldCandle);
    }

    // FX USD contribution lines
    Object.entries(d.fx).forEach(([ccy, obj]) => {
      fxSeries[ccy].update({
        time:t,
        value:obj.usd
      });
    });

    // Total unit overlay
    unitSeries.update({
      time:t,
      value:d.unit_usd
    });

  } catch (err) {
    console.error("Feed error", err);
  }
}

tick();
setInterval(tick, 1000);
</script>
</body>
</html>
