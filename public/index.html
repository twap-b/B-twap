<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BRICS Unit Basket v2 — Candles & FX</title>
<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
<style>
  body{margin:0;font-family:system-ui;background:#0e1117;color:#e6e6e6}
  header{padding:16px 20px;border-bottom:1px solid #1f2937}
  h1{margin:0;font-size:20px;font-weight:600}
  #unitValue{margin-top:6px;font-size:26px;font-weight:700;color:#CD7F32}
  #controls{padding:12px 20px;border-bottom:1px solid #1f2937;display:flex;gap:16px;flex-wrap:wrap}
  label{font-size:14px;cursor:pointer;user-select:none}
  input[type="checkbox"]{margin-right:6px}
  #chart{height:520px}
</style>
</head>
<body>

<header>
  <h1>BRICS Unit — Reference Basket</h1>
  <div id="unitValue">—</div>
</header>

<div id="controls">
  <label><input type="checkbox" data-series="gold" checked> Gold</label>
  <label><input type="checkbox" data-series="BRL" checked> BRL</label>
  <label><input type="checkbox" data-series="RUB" checked> RUB</label>
  <label><input type="checkbox" data-series="INR" checked> INR</label>
  <label><input type="checkbox" data-series="CNY" checked> CNY</label>
  <label><input type="checkbox" data-series="ZAR" checked> ZAR</label>
  <label><input type="checkbox" id="toggleUnit"> BRICS Unit</label>
</div>

<div id="chart"></div>

<script>
const COLORS = {
  gold:"#FFD700",
  BRL:"#1E8F4E",
  RUB:"#B22222",
  INR:"#FF9933",
  CNY:"#D32F2F",
  ZAR:"#1976D2",
  unit:"#CD7F32"
};

const FX_LIST=["BRL","RUB","INR","CNY","ZAR"];
const chart = LightweightCharts.createChart(document.getElementById("chart"),{
  layout:{background:{color:"#0e1117"},textColor:"#d1d5db"},
  grid:{vertLines:{color:"#1f2937"},horzLines:{color:"#1f2937"}},
  timeScale:{timeVisible:true,secondsVisible:true}
});

const series = {
  gold:chart.addCandlestickSeries({upColor:COLORS.gold,downColor:COLORS.gold,wickUpColor:COLORS.gold,wickDownColor:COLORS.gold,borderVisible:false}),
  BRL:chart.addCandlestickSeries({upColor:COLORS.BRL,downColor:COLORS.BRL,borderVisible:false}),
  RUB:chart.addCandlestickSeries({upColor:COLORS.RUB,downColor:COLORS.RUB,borderVisible:false}),
  INR:chart.addCandlestickSeries({upColor:COLORS.INR,downColor:COLORS.INR,borderVisible:false}),
  CNY:chart.addCandlestickSeries({upColor:COLORS.CNY,downColor:COLORS.CNY,borderVisible:false}),
  ZAR:chart.addCandlestickSeries({upColor:COLORS.ZAR,downColor:COLORS.ZAR,borderVisible:false}),
  unit:chart.addCandlestickSeries({upColor:COLORS.unit,downColor:COLORS.unit,borderVisible:false})
};

const history={}; Object.keys(series).forEach(k=>history[k]=[]);

async function poll(){
  const d=await(await fetch("/latest.json")).json();
  const t=Math.floor(Date.now()/1000);

  document.getElementById("unitValue").textContent=`$${d.unit_usd.toFixed(4)} USD`;

  function push(k,v){
    const h=history[k];
    const prev=h[h.length-1];
    const candle={time:t,open:prev?prev.close:v,high:prev?Math.max(v,prev.close):v,low:prev?Math.min(v,prev.close):v,close:v};
    h.push(candle);
    series[k].setData(h);
  }

  push("gold",d.gold.usd_value);
  FX_LIST.forEach(c=>push(c,d.fx[c].usd));
  push("unit",d.unit_usd);
}

setInterval(poll,5000);
poll();

document.querySelectorAll("#controls input").forEach(cb=>cb.addEventListener("change",updateVisibility));

function updateVisibility(){
  const unitOn=document.getElementById("toggleUnit").checked;
  Object.keys(series).forEach(k=>{
    let visible=true,opacity=1;
    if(unitOn){
      if(k==="unit"){visible=true;opacity=1}else{visible=true;opacity=0.25}
    }else{
      const cb=document.querySelector(`input[data-series="${k}"]`);
      visible=cb?cb.checked:false;
      opacity=1;
    }
    series[k].applyOptions({visible,opacity,priceLineVisible:false,lastValueVisible:false});
  });
}
</script>
</body>
</html>
