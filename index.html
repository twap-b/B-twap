<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BRICS Unit Basket v1 – True Market TWAP + Candles</title>
<style>
body { background:#0b0f14; color:#FFD700; font-family: Arial; padding:20px; }
.container { max-width:900px; margin:auto; }
h1 { text-align:center; color:#FFD700; }
.price-box { background:#151a21; padding:20px; border-radius:8px; margin-bottom:20px; color:#FFD700; }
.price-box .price { font-size:2em; text-align:center; margin:10px 0; color:#FFD700; }
.row { margin:5px 0; font-size:1.1em; color:#FFD700; }
#chart { height:400px; margin-top:20px; background:#0b0f14; border-radius:8px; }
select { margin-top:10px; padding:5px; font-size:1em; color:#0b0f14; background:#FFD700; font-weight:bold; border-radius:4px; border:none; }
.footnote { font-size:0.85em; color:#FFD700; margin-top:20px; line-height:1.4; }
</style>
</head>
<body>

<div class="container">
<h1>BRICS Unit Basket v1 – Live True Market TWAP + Candles</h1>

<div class="price-box">
<div class="price">Reference Price (USD): <strong><span id="unitUsd">…</span></strong></div>
<div class="row">Gold TWAP (USD / troy oz): <span id="goldTwap">…</span></div>
<div class="row">Unit (grams gold): <span id="unitGold">…</span></div>
<div class="row">100 Units (USD): <span id="hundredUsd">…</span></div>
<div class="row">Last Update (UTC): <span id="timestamp">…</span></div>
<div class="row">
Timeframe: 
<select id="timeframe">
<option value="1">1 min</option>
<option value="15">15 min</option>
<option value="30">30 min</option>
<option value="60">1 hour</option>
<option value="180">3 hour</option>
<option value="1440">1 day</option>
<option value="4320">3 day</option>
<option value="10080">1 week</option>
<option value="43200">1 month</option>
</select>
</div>
</div>

<div id="chart"></div>

<div class="footnote">
<b>Methodology:</b> Basket v1 = 40% gold, 12% each BRL/RUB/INR/CNY/ZAR; gold in troy oz; 5-second TWAP for all 6 assets; chart updates every second; selectable timeframes; history persisted across reloads; last 1000 candles per timeframe in browser; frontend computes true market price using live FX + gold.
</div>
</div>

<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
<script>
const FX_FEED_URL = "https://YOUR_SERVER_URL/fx_rates.json";   // Should return {BRL:.., RUB:.., INR:.., CNY:.., ZAR:..}
const GOLD_FEED_URL = "https://YOUR_SERVER_URL/gold.json";     // Should return {usd_per_oz: .., timestamp_utc: ..}
const OHLC_URL = "https://YOUR_SERVER_URL/ohlc";
const updateInterval = 1000;
const MAX_CANDLES = 1000;

// ===== Chart Setup =====
const chartContainer = document.getElementById('chart');
const chart = LightweightCharts.createChart(chartContainer, {
    layout: { backgroundColor: '#0b0f14', textColor: '#FFD700' },
    grid: { vertLines: { color: '#333' }, horzLines: { color: '#333' } },
    rightPriceScale: { borderColor:'#555' },
    timeScale: { borderColor:'#555', timeVisible:true, secondsVisible:true }
});
const candleSeries = chart.addCandlestickSeries({ upColor: '#FFD700', downColor: '#FFA500', borderVisible:false, wickColor: '#FFD700' });

// ===== Data storage =====
let timeframeMin = parseInt(document.getElementById('timeframe').value);
let candles = [];
let currentCandle = null;

// ===== Candle helpers =====
function getCandleTime(ts, tf_min) {
    return Math.floor(ts/(tf_min*60))*tf_min*60;
}

// ===== Load historical candles =====
async function loadHistoricalCandles() {
    try {
        const res = await fetch(`${OHLC_URL}?timeframe=${timeframeMin}&limit=${MAX_CANDLES}`);
        const data = await res.json();
        candles = data || [];
        if(candles.length > MAX_CANDLES) candles = candles.slice(-MAX_CANDLES);
        currentCandle = candles.length ? candles[candles.length-1] : null;
        candleSeries.setData(candles);
    } catch(e) { console.error("Failed to load historical candles", e); }
}

// ===== Compute True Market Unit USD =====
async function computeUnitUSD() {
    try {
        const [fxRes, goldRes] = await Promise.all([
            fetch(FX_FEED_URL),
            fetch(GOLD_FEED_URL)
        ]);
        const fx = await fxRes.json();    // {BRL:.., RUB:.., INR:.., CNY:.., ZAR:..}
        const goldData = await goldRes.json(); // {usd_per_oz: .., timestamp_utc: ..}

        // Basket weights
        const weights = { gold: 0.40, BRL:0.12, RUB:0.12, INR:0.12, CNY:0.12, ZAR:0.12 };

        // Gold in grams
        const goldGram = goldData.usd_per_oz / 31.1034768; // 1 troy oz = 31.1034768 g

        // Compute weighted unit price
        let unitUSD = weights.gold * goldGram;
        unitUSD += weights.BRL * fx.BRL;
        unitUSD += weights.RUB * fx.RUB;
        unitUSD += weights.INR * fx.INR;
        unitUSD += weights.CNY * fx.CNY;
        unitUSD += weights.ZAR * fx.ZAR;

        // Update UI
        document.getElementById("unitUsd").innerText = unitUSD.toFixed(2);
        document.getElementById("unitGold").innerText = goldGram.toFixed(6);
        document.getElementById("hundredUsd").innerText = (unitUSD*100).toFixed(2);
        document.getElementById("goldTwap").innerText = goldData.usd_per_oz.toFixed(2);
        document.getElementById("timestamp").innerText = goldData.timestamp_utc.replace("T"," ").replace("Z"," UTC");

        return {unitUSD, timestamp: goldData.timestamp_utc};

    } catch(e) { console.error("Failed to compute Unit USD", e); return null; }
}

// ===== Update Candles =====
async function updateCandles() {
    const data = await computeUnitUSD();
    if(!data) return;

    const tsUnix = new Date(data.timestamp).getTime()/1000;
    const candleTime = getCandleTime(tsUnix, timeframeMin);

    if(!currentCandle || currentCandle.time !== candleTime){
        if(currentCandle) candles.push(currentCandle);
        currentCandle = { time: candleTime, open: data.unitUSD, high: data.unitUSD, low: data.unitUSD, close: data.unitUSD };
        if(candles.length > MAX_CANDLES) candles = candles.slice(-MAX_CANDLES);
        candleSeries.setData(candles.concat([currentCandle]));

        // Persist to server
        fetch(`${OHLC_URL}/update`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(currentCandle)
        });

        localStorage.setItem("candles_" + timeframeMin, JSON.stringify(candles));
    } else {
        currentCandle.high = Math.max(currentCandle.high, data.unitUSD);
        currentCandle.low = Math.min(currentCandle.low, data.unitUSD);
        currentCandle.close = data.unitUSD;
        candleSeries.update(currentCandle);
    }
}

// ===== Initial Load =====
async function init() {
    candles = JSON.parse(localStorage.getItem("candles_" + timeframeMin)) || [];
    if(candles.length > MAX_CANDLES) candles = candles.slice(-MAX_CANDLES);
    currentCandle = candles.length ? candles[candles.length-1] : null;
    candleSeries.setData(candles);

    await loadHistoricalCandles();
    updateCandles();
    setInterval(updateCandles, updateInterval);
}

// ===== Handle timeframe change =====
document.getElementById('timeframe').addEventListener('change', ()=>{
    timeframeMin = parseInt(document.getElementById('timeframe').value);
    init();
});

init();
</script>
</body>
</html>
